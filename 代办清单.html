<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>代办清单</title>
    <script src="jq.js"></script>
    <style>
        html,
        body,
        ul,
        ol,
        li,
        input,
        p,
        span,
        a,
        article,
        header,
        h1 {
            margin: 0px;
            padding: 0px;
        }

        body {
            font: 600 20px/30px consolas;
            /* color: brown; */
            background-color: #e5e5e5;
        }

        ul,
        ol {
            list-style: none;
        }

        li {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        li.moving {
            opacity: 0.2;
            color: transparent;
            border: dotted 1px gray;
        }

        li input {
            width: 10%;
            height: 20px;
        }

        li p {
            width: 80%;
        }

        #doing li span {
            background-image:
                linear-gradient(217deg, rgba(255, 0, 0, .8), rgba(255, 0, 0, 0.2) 70.71%),
                linear-gradient(127deg, rgba(0, 255, 0, .8), rgba(0, 255, 0, 0.2) 70.71%),
                linear-gradient(336deg, rgba(0, 0, 255, .8), rgba(0, 0, 255, 0.2) 70.71%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        #done li span {
            color: rgb(145, 145, 145);
            text-decoration: line-through;
        }

        li a {
            width: 10%;
            text-align: center;
            text-decoration: none;
            color: dodgerblue;
        }

        header {
            padding: 20px 40px;
            background-color: #ccc;
        }

        article {
            width: 60%;
            min-width: 800px;
            margin: 0 auto;

        }

        article * {
            vertical-align: bottom;
        }

        header h1 {
            margin: 0px;
            display: inline-block;
            width: 30%;
        }

        header input[type=text] {
            height: 26px;
            width: 40%;
            padding-left: .5em;
        }

        header input[type=button] {
            width: 80px;
            height: 30px;
            margin: 0 20px;
            font: 700 20px/1.5 caption;
        }
    </style>
</head>

<body>
    <header>
        <article>
            <h1>代办清单</h1>
            <input type="text" id='txt'>
            <input type="button" value="添 加" id='add'>
        </article>
    </header>
    <article>
        <ul id="doing">
        </ul>
        <h3>&nbsp;&nbsp;已完成</h3>
        <ul id="done">
        </ul>
    </article>
    <footer></footer>
    <script>
        $(function () {
            // 读取本地记录，第一次会有默认值
            var doList = JSON.parse(localStorage.getItem('doList'))
            if (doList === null) {
                doList = [
                    { id: 0, do: true, title: '这些数据只在第一次出现' },
                    { id: 1, do: true, title: '这是一个代办列表,它的数据存储在浏览器缓存中' },
                    { id: 2, do: true, title: '它已经新增了代办的拖动事件以调整顺序' },
                    { id: 3, do: true, title: '使用了闭包和防抖，每一毫秒仅能执行一次添加代办函数' },
                    { id: 4, do: true, title: '重新梳理了逻辑,重写了部分代码' },
                    { id: 5, do: false, title: '1.接下来尝试去掉每个函数都对localstorage的操作,改为关闭刷新自动保存' },
                    { id: 6, do: false, title: '2.文本过长时,checked和a的位置需要改动' },
                    { id: 7, do: false, title: '3.bug,jq的收起动画有时出错,尝试去掉jq使用原生' }
                ]
            }

            // 根据数据添加li，翻转数组是为了让后添加的数据出现在最前面
            $('#doing').prepend(doList.map(item => !item.do ? createItem(item) : null).reverse())
            $('#done').prepend(doList.map(item => item.do ? createItem(item) : null).reverse())

            // 添加代办的函数
            var addtxt = (function () {
                // 防抖,闭包
                var addBoolean = true
                // 获取input文本节点
                const title = $('#txt')
                return function () {
                    if (!addBoolean || title.val().trim() === '') {
                        return console.info('不能创建空的代办')
                    } else {
                        // 创建新的待办项数据
                        addBoolean = false
                        const id = Date.now()
                        setTimeout(() => {
                            addBoolean = true
                        }, 1)
                        const newItem = { id: id, do: false, title: title.val().trim() }
                        // 添加到数组内
                        doList.push(newItem)
                        // 根据数据创建dom，添加到代办的最上面，用0s收起，然后展开实现动画
                        const li = createItem(newItem)
                        $('#doing').prepend(li)
                        li.slideUp(0).slideDown()
                        // 保存本地
                        localStorage.setItem('doList', JSON.stringify(doList))
                    }
                    // 置空input
                    title.val('')
                }
            })()

            // 新增代办，回车或者点击添加按钮
            $('#add').click(addtxt)

            $('#txt').keyup(e => {
                e.keyCode === 13 && addtxt()
            })

            // 给a和chekbox添加点击事件，拖动事件
            $('#doing, #done')
                .on('click', 'a', delItem)
                .on('click', 'input', toggleItem)
                .on('dragstart', 'li', function (e) {
                    // li拖动开始，异步添加类名，保证拖出来的元素不会应用新的class
                    setTimeout(() => e.target.classList.add('moving'), 0)
                })
                .on('dragenter', 'li', function (e) {
                    // 拖动到哪个li上？获取拖动起来的dom-li
                    const drag_li = $('.moving')
                    const drag_id = drag_li.attr('index')
                    // 获取拖动dom-li在数组里的index
                    const drag_index = doList.findIndex(item => item.id == drag_id)
                    // 如果拖到自己身上就直接结束
                    if (doList[drag_index].id == $(e.currentTarget).attr('index')) { return }
                    // 拖动的li对应的代办数据项
                    const drag_item = doList[drag_index]

                    // 如果拖到别的dom-li上，把旧dom-li，添加到新dom-li的下方
                    $(e.currentTarget).after(drag_li)
                    // 修改dolist数据，并保存

                    const newdoList = []
                    // 把拖动的li放在被拖入的下边
                    // 把拖动的dom-li-checked设置成被拖入的
                    const current_target_index = $(e.currentTarget).attr('index')
                    for (const item of doList) {
                        if (item.id == current_target_index) {
                            newdoList.push(drag_item)
                            drag_item.do = item.do
                            drag_li.children('input').prop('checked', item.do)
                        }
                        if (item.id != drag_id) {
                            newdoList.push(item)
                        }
                    }
                    // 保存                  
                    localStorage.setItem('doList', JSON.stringify(doList = newdoList))
                })
                .on('dragend', 'li', function (e) {
                    // li拖动结束，移除class
                    e.target.classList.remove('moving')
                })

            // 删除某一项代办，接受代办内删除链接的事件对象
            function delItem(e) {
                // 获取dom-li
                var li = $(e.target).parents('li[index]')
                // 收起dom后，删除dom
                li.slideUp(li.remove)
                // 过滤dolist并存储，这里获取的id是字符串，注意不要使用全等
                var select_id = li.attr('index')
                // 使用findIndex + splice 还是 filter呢
                doList = doList.filter(item => item.id != select_id)
                localStorage.setItem('doList', JSON.stringify(doList))
            }

            // 点击checkBox切换某一项代办的状态，参数为checkbox的点击事件对象
            function toggleItem(e) {
                // 根据事件对象获取父元素li节点
                var li = $(e.target).parent('li[index]')
                var toggle_id = li.attr('index')

                var newItem
                // 过滤掉dolist中点击的item
                doList = doList.filter(item => {
                    if (item.id != toggle_id) {
                        return true
                    } else {
                        // 把旧的item给新item，设置选择状态
                        newItem = item
                        newItem.do = e.target.checked
                        return false
                    }
                })
                // 新item添加到dolist中
                doList.push(newItem)
                // 将点击的dom收起，回调=》根据checked状态添加到done或doing中
                li.slideUp(() => $(e.target.checked ? '#done' : '#doing').prepend(li.slideDown()))
                // 存储dolist
                localStorage.setItem('doList', JSON.stringify(doList))
            }

            // 根据数据创建单个DOM-li节点
            function createItem(item) {
                return $(`<li index=${item.id} draggable=true>
                    <input type="checkbox" ${item.do ? "checked" : ''}>
                    <p><span>${item.title}</span></p>
                    <a href="javascript:;">删 除</a>
                </li>`)
            }

        })
    </script>
</body>

</html>