<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>代办清单</title>
    <script src="jq.js"></script>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }

        body {
            font: 600 20px/30px consolas;
            /* color: brown; */
            background-color: #e5e5e5;
        }

        ul,
        ol {
            list-style: none;
        }

        li {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        li.moving {
            opacity: 0.2;
            color: transparent;
            border: dotted 1px gray;
        }

        li input {
            width: 10%;
            height: 20px;
        }

        li p {
            width: 80%;
        }

        #doing li span {
            background-image:
                linear-gradient(217deg, rgba(255, 0, 0, .8), rgba(255, 0, 0, 0.2) 70.71%),
                linear-gradient(127deg, rgba(0, 255, 0, .8), rgba(0, 255, 0, 0.2) 70.71%),
                linear-gradient(336deg, rgba(0, 0, 255, .8), rgba(0, 0, 255, 0.2) 70.71%);
            -webkit-background-clip: text;
            color: transparent;
        }

        #done li span {
            color: rgb(145, 145, 145);
            text-decoration: line-through;
        }

        li a {
            width: 10%;
            text-align: center;
            text-decoration: none;
            color: dodgerblue;
        }

        header {
            padding: 20px 40px;
            background-color: #ccc;
        }

        article {
            width: 60%;
            min-width: 800px;
            margin: 0 auto;

        }

        article * {
            vertical-align: bottom;
        }

        header h1 {
            margin: 0px;
            display: inline-block;
            width: 30%;
        }

        header input[type=text] {
            height: 26px;
            width: 40%;
        }

        header input[type=button] {
            width: 80px;
            height: 30px;
            margin: 0 20px;
            font: 700 20px/1.5 caption;
        }
    </style>
</head>

<body>
    <header>
        <article>
            <h1>代办清单</h1>
            <input type="text" id='txt'>
            <input type="button" value="添 加" id='add'>
        </article>
    </header>
    <article>
        <ul id="doing">
        </ul>
        <h3>&nbsp;&nbsp;已完成</h3>
        <ul id="done">
        </ul>
    </article>
    <footer></footer>
    <script>
        $(function () {
            // 读取本地记录
            var doList = JSON.parse(localStorage.getItem('doList')) || [];
            if (doList.length == 0) {
                doList = [
                    { id: 0, do: false, title: '这些数据只在第一次出现' },
                    { id: 1, do: false, title: '它已经新增了代办的拖动事件以调整顺序' },
                    { id: 2, do: true, title: '这是一个代办列表,它的数据存储在浏览器缓存中' },
                ]
            };

            // 根据数据添加li
            $('#doing').prepend(doList.map(item => !item.do ? createItem(item) : null).reverse())
            $('#done').prepend(doList.map(item => item.do ? createItem(item) : null).reverse())

            // 给a和chekbox添加点击事件，拖动事件
            $('#doing, #done')
                .on('click', 'a', delItem)
                .on('click', 'input', toggleItem)
                .on('dragstart', 'li', function (e) {
                    setTimeout(() => e.target.classList.add('moving'), 0)
                })
                .on('dragenter', 'li', function (e) {
                    // 往上还是往下，调整doList顺序，并存储
                    const oldNode = $('.moving')
                    const newItem = { id: oldNode.attr('index'), do: false, title: oldNode.find('span').text() }
                    if(newItem.id == $(e.currentTarget).attr('index')){return}
                    $(e.currentTarget).after(oldNode)
                    const newdoList = []
                    for(const item of doList){
                        if(item.id == $(e.currentTarget).attr('index')){
                            newdoList.push(newItem)
                            newItem.do = item.do
                            oldNode.children('input').prop('checked',item.do)
                        }
                        if(item.id != newItem.id){
                            newdoList.push(item)
                        }
                    }
                    doList = newdoList
                    localStorage.setItem('doList', JSON.stringify(doList))
                })
                .on('dragend', 'li', function (e) {
                    e.target.classList.remove('moving')
                })

            function delItem(e) {
                var li = $(e.target).parent()
                li.slideUp(li.remove)
                doList = doList.filter(item => item.id != li.attr('index'))
                localStorage.setItem('doList', JSON.stringify(doList))
            }

            function toggleItem(e) {
                var li = $(e.target).parent()
                var newItem = {}
                var newdoList = doList.filter(item => {
                    if (item.id != li.attr('index')) {
                        return true
                    } else {
                        newItem = item
                        newItem.do = e.target.checked
                        return false
                    }
                })
                newdoList.push(newItem)
                doList = newdoList
                li.slideUp(() => $(e.target.checked ? '#done' : '#doing').prepend(li.slideDown()))
                localStorage.setItem('doList', JSON.stringify(doList))
            }

            function createItem(item) {
                return $(`<li index=${item.id} draggable="true">
                    <input type="checkbox" ${item.do ? "checked" : ''}>
                    <p><span>${item.title}</span></p>
                    <a href="javascript:;">删 除</a>
                </li>`)
            }

            $('#add').click(addtxt)

            $('#txt').keyup(function (e) {
                e.keyCode === 13 && addtxt()
            })

            function addtxt() {
                const title = $('#txt')
                if (title.val() === '') {
                    return false;
                } else {
                    const newItem = { id: new Date(), do: false, title: title.val() }
                    doList.push(newItem)
                    var li = createItem(newItem)
                    $('#doing').prepend(li)
                    li.slideUp(0).slideDown()
                    title.val('')
                    localStorage.setItem('doList', JSON.stringify(doList))
                }
            }

        })
    </script>
</body>

</html>